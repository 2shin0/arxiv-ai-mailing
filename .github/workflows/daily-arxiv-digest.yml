name: Daily arXiv AI Papers Digest

on:
  schedule:
    # ì›”-ê¸ˆ ì˜¤ì „ 10ì‹œ (KST) = UTC ì˜¤ì „ 1ì‹œ ì‹¤í–‰
    - cron: '0 1 * * 1-5'
    # ìž¬ì‹œë„: ì˜¤ì „ 11ì‹œ (KST) = UTC ì˜¤ì „ 2ì‹œ
    - cron: '0 2 * * 1-5'
    # ìž¬ì‹œë„: ì˜¤í›„ 12ì‹œ (KST) = UTC ì˜¤ì „ 3ì‹œ
    - cron: '0 3 * * 1-5'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate-and-send-digest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Create Google API credentials file
      run: |
        echo '${{ secrets.GOOGLE_API_CREDENTIALS }}' > google_credentials.json
        echo "GOOGLE_API_CREDENTIALS_PATH=google_credentials.json" >> $GITHUB_ENV
    
    - name: Set environment variables
      run: |
        echo "EMAIL_ADDRESS=${{ secrets.EMAIL_ADDRESS }}" >> $GITHUB_ENV
        echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> $GITHUB_ENV
        echo "RECIPIENT=${{ secrets.RECIPIENT }}" >> $GITHUB_ENV
        echo "GOOGLE_SHEET_NAME=${{ secrets.GOOGLE_SHEET_NAME }}" >> $GITHUB_ENV
        echo "GOOGLE_WORKSHEET_NAME=${{ secrets.GOOGLE_WORKSHEET_NAME }}" >> $GITHUB_ENV
        echo "GOOGLE_SCRIPT_ID=${{ secrets.GOOGLE_SCRIPT_ID }}" >> $GITHUB_ENV
        echo "DEEPL_API_KEY=${{ secrets.DEEPL_API_KEY }}" >> $GITHUB_ENV
    
    - name: Check if already processed today
      id: check_status
      run: |
        # ì˜¤ëŠ˜ ë‚ ì§œ í™•ì¸
        TODAY=$(date +'%Y-%m-%d')
        echo "today=$TODAY" >> $GITHUB_OUTPUT
        
        # ì´ë¯¸ ì²˜ë¦¬ëœ íŒŒì¼ì´ ìžˆëŠ”ì§€ í™•ì¸
        if [ -f "results/${TODAY}_digest.json" ] || [ -f "digest/ALL/${TODAY}.md" ]; then
          echo "already_processed=true" >> $GITHUB_OUTPUT
          echo "âœ… Today's digest already exists. Skipping execution."
        else
          echo "already_processed=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ No digest found for today. Proceeding with execution."
        fi
    
    - name: Run arXiv digest generation
      id: run_digest
      if: steps.check_status.outputs.already_processed == 'false'
      run: |
        echo "ðŸš€ Starting arXiv digest generation..."
        
        # ì‹¤í–‰ ì‹œìž‘ ì‹œê°„ ê¸°ë¡
        START_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
        
        # main.py ì‹¤í–‰ ë° ê²°ê³¼ ìº¡ì²˜
        if python main.py > execution.log 2>&1; then
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… Digest generation completed successfully"
          
          # ìƒì„±ëœ ë…¼ë¬¸ ìˆ˜ í™•ì¸ (ë” ì•ˆì •ì ì¸ ë°©ë²•)
          PAPER_COUNT=$(grep -E "Total papers found: [0-9]+" execution.log | tail -1 | grep -oE "[0-9]+" || echo "0")
          echo "paper_count=$PAPER_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Papers processed: $PAPER_COUNT"
          
          # ë…¼ë¬¸ì´ ì—†ëŠ” ê²½ìš° ê²½ê³  í‘œì‹œ
          if [ "$PAPER_COUNT" -eq "0" ]; then
            echo "âš ï¸ Warning: No papers found for today"
            echo "warning=no_papers_found" >> $GITHUB_OUTPUT
          else
            echo "âœ… Successfully processed $PAPER_COUNT papers"
          fi
        else
          echo "success=false" >> $GITHUB_OUTPUT
          echo "âŒ Digest generation failed"
          
          # ì—ëŸ¬ ë¡œê·¸ ì¶œë ¥
          echo "=== ERROR LOG ==="
          cat execution.log
          echo "================="
          
          # ì‹¤íŒ¨ ì´ìœ  ë¶„ì„ (ë” ì •í™•í•œ íŒ¨í„´ ë§¤ì¹­)
          if grep -qE "(No papers found|0 papers)" execution.log; then
            echo "error_reason=no_papers_available" >> $GITHUB_OUTPUT
          elif grep -qE "(Failed to fetch|Connection|Network|HTTP)" execution.log; then
            echo "error_reason=network_error" >> $GITHUB_OUTPUT
          elif grep -qE "(API|Authentication|Credentials)" execution.log; then
            echo "error_reason=api_error" >> $GITHUB_OUTPUT
          elif grep -qE "(Permission|Access)" execution.log; then
            echo "error_reason=permission_error" >> $GITHUB_OUTPUT
          else
            echo "error_reason=unknown_error" >> $GITHUB_OUTPUT
          fi
          
          exit 1
        fi
    
    - name: Configure Git
      if: steps.run_digest.outputs.success == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Deploy to GitHub Pages
      if: steps.run_digest.outputs.success == 'true'
      id: deploy
      run: |
        echo "ðŸ“¤ Deploying to GitHub Pages..."
        
        # arxiv-digest ë¸Œëžœì¹˜ë¡œ ì „í™˜í•˜ì—¬ ë‹¤ì´ì œìŠ¤íŠ¸ íŒŒì¼ë“¤ ì»¤ë°‹
        git checkout -B arxiv-digest
        git add digest/
        git add results/
        
        # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if ! git diff --staged --quiet; then
          git commit -m "Add arXiv digest for ${{ steps.check_status.outputs.today }} (Papers: ${{ steps.run_digest.outputs.paper_count }})"
          git push origin arxiv-digest --force
          echo "digest_deployed=true" >> $GITHUB_OUTPUT
        else
          echo "digest_deployed=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No changes to deploy in digest branch"
        fi
        
        # main ë¸Œëžœì¹˜ë¡œ ì „í™˜í•˜ì—¬ ì¸ë±ìŠ¤ íŒŒì¼ë“¤ ì—…ë°ì´íŠ¸
        git checkout main
        git add LLM/index.md ALL/index.md
        
        # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ” ê²½ìš°ì—ë§Œ ì»¤ë°‹
        if ! git diff --staged --quiet; then
          git commit -m "Update index pages for ${{ steps.check_status.outputs.today }}"
          git push origin main
          echo "index_deployed=true" >> $GITHUB_OUTPUT
        else
          echo "index_deployed=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ No changes to deploy in main branch"
        fi
    
    - name: Create execution summary
      if: always()
      run: |
        echo "## ðŸ“Š Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Date**: ${{ steps.check_status.outputs.today }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date +'%H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_status.outputs.already_processed }}" == "true" ]; then
          echo "- **Status**: â­ï¸ Skipped (already processed)" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.run_digest.outputs.success }}" == "true" ]; then
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Papers Found**: ${{ steps.run_digest.outputs.paper_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest Deployed**: ${{ steps.deploy.outputs.digest_deployed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Index Updated**: ${{ steps.deploy.outputs.index_deployed }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.run_digest.outputs.warning }}" == "no_papers_found" ]; then
            echo "- **Warning**: âš ï¸ No papers found for today" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "- **Error Reason**: ${{ steps.run_digest.outputs.error_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Next Retry**: $(date -d '+1 hour' +'%H:%M KST')" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload execution log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: execution-log-${{ steps.check_status.outputs.today }}
        path: execution.log
        retention-days: 7
    
    - name: Clean up credentials
      if: always()
      run: |
        rm -f google_credentials.json
